<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot da Empresa Serval</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Adicionar o CSRF token como meta tag -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        body {
            background-color: #f8f9fa;
        }
        #chat-window {
            height: 70vh;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-y: auto;
            padding: 15px;
            background-color: #fff;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .user-message {
            align-items: flex-end;
        }
        .bot-message {
            align-items: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }
        .user-message .message-bubble {
            background-color: #0d6efd;
            color: white;
            border-bottom-right-radius: 0;
        }
        .bot-message .message-bubble {
            background-color: #e9ecef;
            color: #212529;
            border-bottom-left-radius: 0;
        }
        #loading-indicator {
            display: none; /* Escondido por padrão */
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Chat de Atendimento - Serval</h4>
            </div>
            <div class="card-body" id="chat-window">
                <div class="message bot-message">
                    <div class="message-bubble">
                        Olá! Como posso ajudar você hoje com base nas informações do nosso documento?
                    </div>
                </div>
            </div>
            <div id="loading-indicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Digitando...</span>
                </div>
            </div>
            <div class="card-footer">
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Digite sua mensagem..." autocomplete="off" required>
                        <button class="btn btn-primary" type="submit">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatWindow = document.getElementById('chat-window');
        const loadingIndicator = document.getElementById('loading-indicator');
        const chatHistory = [];

         // Função para obter o CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // 1. Adicionar mensagem do usuário à tela
            appendMessage(userMessage, 'user');
            messageInput.value = '';
            showLoading(true);

            // 2. Enviar mensagem para o backend
            try {
                const csrftoken = getCookie('csrftoken');
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({
                        question: userMessage,
                        history: chatHistory
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Erro da API:', errorData);
                    throw new Error(`Erro na resposta da API: ${response.status}`);
                }

                const data = await response.json();
                const botMessage = data.answer;

                // 3. Adicionar resposta do bot à tela
                appendMessage(botMessage, 'bot');

                // 4. Atualizar o histórico
                chatHistory.push([userMessage, botMessage]);

            } catch (error) {
                console.error('Erro:', error);
                appendMessage('Desculpe, ocorreu um erro. Tente novamente mais tarde.', 'bot');
            } finally {
                showLoading(false);
            }
        });

        function appendMessage(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message', `${sender}-message`);

            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');
            messageBubble.textContent = message;

            messageWrapper.appendChild(messageBubble);
            chatWindow.appendChild(messageWrapper);

            // Rolar para a última mensagem
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        function showLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.style.display = 'flex';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>